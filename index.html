<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat en Direct avec les Potos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        header { background: linear-gradient(to right, #4776E6, #8E54E9); color: white; padding: 20px; text-align: center; }
        .setup { padding: 30px; text-align: center; }
        .setup h2 { color: #333; margin-bottom: 20px; }
        input, button { padding: 12px; margin: 5px; border-radius: 8px; border: 2px solid #ddd; }
        button { background: #4776E6; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #3a60c4; }
        .chat { display: none; padding: 20px; }
        .messages { height: 400px; overflow-y: auto; border: 2px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: #f9f9f9; }
        .message { margin: 10px 0; padding: 10px; border-radius: 10px; max-width: 80%; }
        .my { background: #4776E6; color: white; margin-left: auto; }
        .other { background: #f0f0f0; }
        .input-area { display: flex; gap: 10px; }
        .input-area input { flex: 1; }
        .status { padding: 10px; text-align: center; background: #e8f4fd; border-radius: 8px; margin-bottom: 15px; }
        .connected { background: #d4edda; }
        footer { text-align: center; padding: 15px; background: #f8f9fa; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí¨ Chat en Direct avec les Potos</h1>
            <p>Tous vos amis voient les m√™mes messages en temps r√©el !</p>
        </header>
        
        <div class="setup" id="setup">
            <h2>Configuration Simple (2 minutes)</h2>
            
            <p><strong>√âtape 1 :</strong> Cr√©ez un compte gratuit sur <a href="https://supabase.com" target="_blank">supabase.com</a></p>
            <p><strong>√âtape 2 :</strong> Cr√©ez un projet et une table "messages"</p>
            <p><strong>√âtape 3 :</strong> Copiez vos identifiants ici :</p>
            
            <div style="text-align: left; max-width: 500px; margin: 20px auto;">
                <div>
                    <label>URL Supabase :</label><br>
                    <input type="text" id="url" placeholder="https://xxxxxxxx.supabase.co" style="width: 100%;">
                </div>
                <div style="margin-top: 15px;">
                    <label>Cl√© API (anon public) :</label><br>
                    <input type="text" id="key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." style="width: 100%;">
                </div>
                <div style="margin-top: 15px;">
                    <label>Votre pseudo :</label><br>
                    <input type="text" id="username" placeholder="Votre nom" value="Poto" style="width: 100%;">
                </div>
            </div>
            
            <button onclick="startChat()" style="padding: 15px 30px; font-size: 18px; margin-top: 20px;">
                üöÄ Lancer le Chat en Temps R√©el
            </button>
            
            <div style="margin-top: 30px; background: #fff3cd; padding: 15px; border-radius: 8px;">
                <p><strong>Mode test :</strong> Pas envie de configurer ?</p>
                <button onclick="startTestMode()" style="background: #6c757d;">
                    üéÆ Tester en mode solo d'abord
                </button>
            </div>
        </div>
        
        <div class="chat" id="chat">
            <div class="status" id="status">Connexion...</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>üí¨ Salon de discussion</h2>
                <div>
                    <span style="font-weight: bold; color: #4776E6;" id="currentUser"></span>
                    <button onclick="changeUser()" style="margin-left: 10px; padding: 5px 10px; background: #f0f0f0; color: #333;">
                        ‚úèÔ∏è
                    </button>
                </div>
            </div>
            
            <div class="messages" id="messages">
                <div class="message" style="background: #fff3cd; max-width: 100%;">
                    <strong>Syst√®me</strong><br>
                    Chargement des messages...
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="√âcrivez votre message ici..." onkeypress="if(event.key=='Enter') sendMessage()">
                <button onclick="sendMessage()">üì§ Envoyer</button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <p><small>Partagez ce lien avec vos amis : <span id="pageUrl"></span></small></p>
                <button onclick="clearChat()" style="background: #dc3545; margin-top: 10px;">
                    üóëÔ∏è Effacer l'historique
                </button>
            </div>
        </div>
        
        <footer>
            <p>Chat cr√©√© en 30min ‚Ä¢ Messages en temps r√©el ‚Ä¢ Partagez avec vos potos !</p>
        </footer>
    </div>
    
    <!-- Inclure Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Variables
        let supabase = null;
        let currentUser = "Poto";
        let isTestMode = false;
        
        // D√©marrer le chat avec Supabase
        async function startChat() {
            const url = document.getElementById('url').value.trim();
            const key = document.getElementById('key').value.trim();
            const username = document.getElementById('username').value.trim() || "Poto";
            
            if (!url || !key) {
                alert("Veuillez entrer l'URL et la cl√© Supabase");
                return;
            }
            
            currentUser = username;
            isTestMode = false;
            
            // Afficher le statut
            document.getElementById('status').textContent = "Connexion √† Supabase...";
            
            try {
                // Cr√©er le client Supabase
                supabase = window.supabase.createClient(url, key);
                
                // Tester la connexion
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    // Erreur commune : table non cr√©√©e
                    if (error.message.includes('relation') || error.code === 'PGRST301') {
                        const create = confirm("La table 'messages' n'existe pas. Essayez-vous de la cr√©er ?");
                        
                        if (create) {
                            // Essayer de cr√©er en envoyant un message
                            const { error: insertError } = await supabase
                                .from('messages')
                                .insert({
                                    username: 'System',
                                    message: 'Table cr√©√©e !',
                                    created_at: new Date().toISOString()
                                });
                            
                            if (insertError) {
                                alert("Impossible de cr√©er la table. Cr√©ez-la manuellement dans Supabase > Table Editor");
                                return;
                            }
                        } else {
                            return;
                        }
                    } else {
                        alert("Erreur : " + error.message);
                        return;
                    }
                }
                
                // Cacher la configuration, montrer le chat
                document.getElementById('setup').style.display = 'none';
                document.getElementById('chat').style.display = 'block';
                document.getElementById('currentUser').textContent = currentUser;
                document.getElementById('pageUrl').textContent = window.location.href;
                
                // Charger les messages
                loadMessages();
                
                // Configurer l'√©coute en temps r√©el
                setupRealtime();
                
                document.getElementById('status').textContent = "‚úÖ Connect√© en temps r√©el ! Partagez le lien avec vos amis.";
                document.getElementById('status').className = "status connected";
                
                // Focus sur le champ de message
                setTimeout(() => {
                    document.getElementById('messageInput').focus();
                }, 100);
                
            } catch (error) {
                alert("Erreur : " + error.message);
            }
        }
        
        // Mode test (solo)
        function startTestMode() {
            currentUser = document.getElementById('username').value.trim() || "Poto";
            isTestMode = true;
            
            document.getElementById('setup').style.display = 'none';
            document.getElementById('chat').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser;
            document.getElementById('pageUrl').textContent = window.location.href;
            
            document.getElementById('status').textContent = "üéÆ Mode test - Seul vous voyez ces messages";
            document.getElementById('status').className = "status";
            
            // Vider les messages
            document.getElementById('messages').innerHTML = 
                '<div class="message" style="background: #fff3cd; max-width: 100%;">' +
                '<strong>Syst√®me</strong><br>Mode test activ√©. Vos messages ne sont pas envoy√©s aux autres.' +
                '</div>';
            
            // Focus sur le champ
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 100);
        }
        
        // Charger les messages
        async function loadMessages() {
            if (isTestMode) return;
            
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(100);
                
                if (error) throw error;
                
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                if (data.length === 0) {
                    messagesDiv.innerHTML = 
                        '<div class="message" style="background: #fff3cd; max-width: 100%;">' +
                        '<strong>Syst√®me</strong><br>Soyez le premier √† envoyer un message !' +
                        '</div>';
                    return;
                }
                
                data.forEach(msg => {
                    addMessage(msg.username, msg.message);
                });
                
                // Faire d√©filer vers le bas
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
            } catch (error) {
                console.error("Erreur:", error);
            }
        }
        
        // Configurer l'√©coute en temps r√©el
        function setupRealtime() {
            if (isTestMode || !supabase) return;
            
            // S'abonner aux nouveaux messages
            supabase
                .channel('public:messages')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'messages' },
                    (payload) => {
                        // Ajouter le nouveau message
                        addMessage(payload.new.username, payload.new.message);
                        
                        // Petit son de notification
                        playNotification();
                    }
                )
                .subscribe();
        }
        
        // Ajouter un message √† l'affichage
        function addMessage(username, message) {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            
            div.className = 'message ' + (username === currentUser ? 'my' : 'other');
            div.innerHTML = `<strong>${escapeHtml(username)}</strong><br>${escapeHtml(message)}`;
            
            messagesDiv.appendChild(div);
            
            // Faire d√©filer vers le bas
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Envoyer un message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (isTestMode) {
                // Mode test : ajouter localement
                addMessage(currentUser, text);
                input.value = '';
                return;
            }
            
            // Mode Supabase : envoyer √† la base
            try {
                const { error } = await supabase
                    .from('messages')
                    .insert({
                        username: currentUser,
                        message: text,
                        created_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                input.value = '';
                
            } catch (error) {
                alert("Erreur d'envoi : " + error.message);
            }
        }
        
        // Effacer l'historique
        async function clearChat() {
            if (!confirm("Effacer tous les messages pour tout le monde ?")) return;
            
            if (isTestMode) {
                document.getElementById('messages').innerHTML = 
                    '<div class="message" style="background: #fff3cd; max-width: 100%;">' +
                    '<strong>Syst√®me</strong><br>Historique effac√© (mode test)' +
                    '</div>';
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('messages')
                    .delete()
                    .neq('id', 0);
                
                if (error) throw error;
                
                document.getElementById('messages').innerHTML = 
                    '<div class="message" style="background: #fff3cd; max-width: 100%;">' +
                    '<strong>Syst√®me</strong><br>Historique effac√©' +
                    '</div>';
                
            } catch (error) {
                alert("Erreur : " + error.message);
            }
        }
        
        // Changer de pseudo
        function changeUser() {
            const newName = prompt("Nouveau pseudo :", currentUser);
            if (newName && newName.trim()) {
                currentUser = newName.trim();
                document.getElementById('currentUser').textContent = currentUser;
            }
        }
        
        // Jouer un son de notification
        function playNotification() {
            try {
                // Simple bip
                const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
                audio.volume = 0.3;
                audio.play();
            } catch (e) {
                // Ignorer
            }
        }
        
        // √âchapper le HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialisation
        window.onload = function() {
            // Pr√©-remplir avec un pseudo al√©atoire
            document.getElementById('username').value = "Poto_" + Math.floor(Math.random() * 1000);
            
            // Raccourci Ctrl+L pour le lien
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'l') {
                    prompt("Lien √† partager :", window.location.href);
                }
            });
        };
    </script>
</body>
</html>
