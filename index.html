<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat en Temps R√©el - Potos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        
        header { background: linear-gradient(to right, #4A00E0, #8E2DE2); color: white; padding: 25px; text-align: center; }
        header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        
        .setup { padding: 40px; }
        .config-card { background: #f8f9ff; padding: 30px; border-radius: 15px; margin-bottom: 25px; border: 2px solid #e6e9ff; }
        
        input, button { padding: 15px; border-radius: 10px; border: 2px solid #ddd; font-size: 1rem; }
        input { width: 100%; margin-bottom: 15px; }
        button { background: linear-gradient(to right, #4A00E0, #8E2DE2); color: white; border: none; cursor: pointer; font-weight: bold; transition: transform 0.3s; }
        button:hover { transform: translateY(-3px); }
        
        .chat-container { display: none; padding: 25px; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
        
        .messages { height: 450px; overflow-y: auto; padding: 20px; background: #f9f9f9; border-radius: 15px; margin-bottom: 20px; border: 2px solid #eee; }
        .message { margin-bottom: 15px; padding: 15px; border-radius: 12px; max-width: 80%; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .my { background: linear-gradient(to right, #4A00E0, #8E2DE2); color: white; margin-left: auto; }
        .other { background: #f0f0f0; }
        .system { background: #fff3cd; border-left: 4px solid #ffc107; max-width: 100%; }
        
        .input-area { display: flex; gap: 15px; margin-bottom: 20px; }
        .input-area input { flex: 1; margin: 0; }
        
        .status { padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: bold; }
        .connecting { background: #fff3cd; color: #856404; }
        .connected { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        
        .instructions { background: #e8f4fd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 5px solid #4A00E0; }
        
        .btn-group { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .btn-group button { flex: 1; min-width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí¨ Chat en Temps R√©el</h1>
            <p>Discutez avec vos potos en direct !</p>
        </header>
        
        <div class="setup" id="setup">
            <div class="config-card">
                <h2 style="color: #4A00E0; margin-bottom: 25px; text-align: center;">Configuration</h2>
                
                <div class="instructions">
                    <h3>üö® Solution √† l'erreur "duplicate key" :</h3>
                    <p><strong>Probl√®me :</strong> L'ID ne s'auto-incr√©mente pas correctement.</p>
                    <p><strong>Solution :</strong> Recr√©ez la table avec ce script SQL :</p>
                    <pre style="background: white; padding: 15px; border-radius: 8px; overflow-x: auto;">
CREATE TABLE messages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  username TEXT NOT NULL,
  message TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);</pre>
                </div>
                
                <h3>Vos identifiants :</h3>
                <input type="text" id="url" placeholder="URL Supabase (ex: https://xxx.supabase.co)">
                <input type="text" id="key" placeholder="Cl√© API anon public (ex: eyJhbGci...)">
                <input type="text" id="username" placeholder="Votre pseudo" value="Poto">
                
                <div class="btn-group">
                    <button onclick="startChat()">
                        üöÄ D√©marrer le Chat
                    </button>
                    <button onclick="autoConfigure()" style="background: #6c757d;">
                        ‚ö° Configuration Auto
                    </button>
                    <button onclick="startTestMode()" style="background: #17a2b8;">
                        üéÆ Mode Test Solo
                    </button>
                </div>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <h2 style="color: #4A00E0;">üí¨ Salon de discussion</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-weight: bold; color: #4A00E0;" id="currentUser"></span>
                    <button onclick="changeUser()" style="padding: 8px 15px; background: #f0f0f0; color: #333;">
                        ‚úèÔ∏è Changer
                    </button>
                </div>
            </div>
            
            <div class="status connecting" id="status">Initialisation...</div>
            
            <div class="messages" id="messages">
                <div class="message system">
                    <strong>üí≠ Syst√®me</strong><br>
                    Chargement des messages...
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Tapez votre message ici... (Entr√©e pour envoyer)">
                <button onclick="sendMessage()" id="sendButton">üì§ Envoyer</button>
            </div>
            
            <div style="text-align: center;">
                <p><strong>üîó Partagez ce lien :</strong> <span id="pageUrl" style="color: #4A00E0; word-break: break-all;"></span></p>
                
                <div class="btn-group">
                    <button onclick="showFixDuplicateKey()" style="background: #ffc107; color: #333;">
                        üîß R√©parer erreur "duplicate key"
                    </button>
                    <button onclick="clearChat()" style="background: #dc3545;">
                        üóëÔ∏è Effacer historique
                    </button>
                    <button onclick="showHelp()" style="background: #6c757d;">
                        ‚ùì Aide
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Variables globales
        let supabase = null;
        let currentUser = "Poto";
        let isTestMode = false;
        
        // Initialisation
        function init() {
            // Pr√©-remplir avec un pseudo al√©atoire
            const randomId = Math.floor(Math.random() * 1000);
            document.getElementById('username').value = `Poto_${randomId}`;
            
            // Raccourcis clavier
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'h') showHelp();
                if (e.ctrlKey && e.key === 'f') showFixDuplicateKey();
                if (e.ctrlKey && e.key === 'l') {
                    prompt("üìã Lien √† partager :", window.location.href);
                }
            });
            
            console.log("Chat initialis√© !");
        }
        
        // D√©marrer le chat
        async function startChat() {
            const url = document.getElementById('url').value.trim();
            const key = document.getElementById('key').value.trim();
            const username = document.getElementById('username').value.trim() || "Poto";
            
            // Validation
            if (!url) {
                alert("Veuillez entrer l'URL Supabase");
                return;
            }
            
            if (!key) {
                alert("Veuillez entrer la cl√© API");
                return;
            }
            
            currentUser = username;
            isTestMode = false;
            
            updateStatus("üîå Connexion √† Supabase...", "connecting");
            
            try {
                // Cr√©er le client Supabase
                supabase = window.supabase.createClient(url, key);
                
                // Tester la connexion
                const { data, error } = await supabase
                    .from('messages')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('relation')) {
                        updateStatus("üìã Table 'messages' non trouv√©e", "error");
                        showCreateTableInstructions();
                        return;
                    }
                    throw error;
                }
                
                // Connexion r√©ussie
                showChatInterface();
                await loadMessages();
                setupRealtime();
                
                updateStatus("‚úÖ Connect√© ! Messages en temps r√©el activ√©s.", "connected");
                
            } catch (error) {
                updateStatus(`‚ùå Erreur : ${error.message}`, "error");
                console.error(error);
            }
        }
        
        // Configuration automatique
        async function autoConfigure() {
            const url = document.getElementById('url').value.trim();
            const key = document.getElementById('key').value.trim();
            
            if (!url || !key) {
                alert("Veuillez d'abord entrer l'URL et la cl√©");
                return;
            }
            
            updateStatus("‚öôÔ∏è Configuration automatique en cours...", "connecting");
            
            try {
                supabase = window.supabase.createClient(url, key);
                
                // 1. Essayer de cr√©er la table
                const createResult = await createTableAutomatically();
                
                if (!createResult.success) {
                    updateStatus(`‚ùå ${createResult.message}`, "error");
                    return;
                }
                
                // 2. D√©sactiver RLS
                const rlsResult = await disableRLS();
                
                // 3. D√©marrer le chat
                currentUser = document.getElementById('username').value.trim() || "Poto";
                isTestMode = false;
                
                showChatInterface();
                await loadMessages();
                setupRealtime();
                
                updateStatus("‚úÖ Configuration r√©ussie ! Chat activ√©.", "connected");
                
            } catch (error) {
                updateStatus(`‚ùå Erreur : ${error.message}`, "error");
            }
        }
        
        // Cr√©er la table automatiquement
        async function createTableAutomatically() {
            try {
                // Essayer de cr√©er la table via SQL
                const { error } = await supabase.rpc('exec_sql', {
                    sql: `
                        CREATE TABLE IF NOT EXISTS messages (
                            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                            username TEXT NOT NULL,
                            message TEXT NOT NULL,
                            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
                        );
                    `
                }).catch(async () => {
                    // Si RPC n'existe pas, essayer avec une insertion
                    const { error: insertError } = await supabase
                        .from('messages')
                        .insert({
                            username: 'System',
                            message: 'Test cr√©ation table',
                            created_at: new Date().toISOString()
                        });
                    
                    if (insertError && insertError.message.includes('relation')) {
                        throw new Error("Impossible de cr√©er la table. Cr√©ez-la manuellement.");
                    }
                });
                
                return { success: true, message: "Table cr√©√©e avec succ√®s" };
                
            } catch (error) {
                return { success: false, message: error.message };
            }
        }
        
        // D√©sactiver RLS
        async function disableRLS() {
            try {
                // Essayer de d√©sactiver RLS
                const { error } = await supabase.rpc('exec_sql', {
                    sql: 'ALTER TABLE messages DISABLE ROW LEVEL SECURITY;'
                }).catch(async () => {
                    // Alternative : cr√©er une politique permissive
                    const { error: policyError } = await supabase.rpc('exec_sql', {
                        sql: `
                            CREATE POLICY IF NOT EXISTS "allow_all" ON messages
                            FOR ALL USING (true) WITH CHECK (true);
                        `
                    });
                    
                    if (policyError) {
                        console.warn("Impossible de configurer RLS, continuons...");
                    }
                });
                
                return { success: true };
            } catch (error) {
                return { success: false };
            }
        }
        
        // Afficher l'interface de chat
        function showChatInterface() {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser;
            document.getElementById('pageUrl').textContent = window.location.href;
            
            // Focus sur le champ de message
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 100);
        }
        
        // Mode test solo
        function startTestMode() {
            currentUser = document.getElementById('username').value.trim() || "Poto";
            isTestMode = true;
            
            document.getElementById('setup').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser;
            document.getElementById('pageUrl').textContent = window.location.href;
            
            updateStatus("üéÆ Mode test - Messages locaux seulement", "connecting");
            
            document.getElementById('messages').innerHTML = 
                '<div class="message system">' +
                '<strong>üí≠ Syst√®me</strong><br>Mode test activ√©. Les messages ne sont pas partag√©s.' +
                '</div>';
            
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 100);
        }
        
        // Charger les messages
        async function loadMessages() {
            if (isTestMode) return;
            
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(100);
                
                if (error) {
                    if (error.message.includes('duplicate key')) {
                        showFixDuplicateKey();
                    }
                    throw error;
                }
                
                displayMessages(data || []);
                
            } catch (error) {
                console.error("Erreur chargement:", error);
            }
        }
        
        // Afficher les messages
        function displayMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = 
                    '<div class="message system">' +
                    '<strong>üí≠ Syst√®me</strong><br>Soyez le premier √† envoyer un message !' +
                    '</div>';
                return;
            }
            
            messages.forEach(msg => {
                addMessageToDisplay(msg.username, msg.message);
            });
            
            scrollToBottom();
        }
        
        // Configurer l'√©coute en temps r√©el
        function setupRealtime() {
            if (isTestMode || !supabase) return;
            
            supabase
                .channel('public:messages')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'messages' },
                    (payload) => {
                        addMessageToDisplay(payload.new.username, payload.new.message);
                        playNotification();
                    }
                )
                .subscribe();
        }
        
        // Ajouter un message √† l'affichage
        function addMessageToDisplay(username, message) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            
            // Nettoyer le contenu syst√®me
            const systemMsg = container.querySelector('.system');
            if (systemMsg && systemMsg.textContent.includes('premier')) {
                systemMsg.remove();
            }
            
            // D√©terminer la classe
            const isOwnMessage = username === currentUser;
            const isSystem = username === 'System' || username.includes('Syst√®me');
            
            div.className = 'message ' + (isOwnMessage ? 'my' : (isSystem ? 'system' : 'other'));
            div.innerHTML = `<strong>${escapeHtml(username)}</strong><br>${escapeHtml(message)}`;
            
            container.appendChild(div);
            scrollToBottom();
        }
        
        // Envoyer un message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // D√©sactiver temporairement le bouton
            const button = document.getElementById('sendButton');
            button.disabled = true;
            button.innerHTML = '‚è≥ Envoi...';
            
            if (isTestMode) {
                // Mode test
                setTimeout(() => {
                    addMessageToDisplay(currentUser, message);
                    input.value = '';
                    input.focus();
                    button.disabled = false;
                    button.innerHTML = 'üì§ Envoyer';
                }, 300);
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('messages')
                    .insert({
                        username: currentUser,
                        message: message,
                        created_at: new Date().toISOString()
                    });
                
                if (error) {
                    if (error.message.includes('duplicate key')) {
                        updateStatus("‚ùå Erreur 'duplicate key' - Voir solution ci-dessous", "error");
                        showFixDuplicateKey();
                    } else if (error.message.includes('row-level security')) {
                        updateStatus("‚ùå Erreur RLS - D√©sactivez RLS", "error");
                        showRLSInstructions();
                    } else {
                        throw error;
                    }
                    return;
                }
                
                input.value = '';
                input.focus();
                
            } catch (error) {
                alert(`Erreur : ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = 'üì§ Envoyer';
            }
        }
        
        // Afficher solution pour duplicate key
        function showFixDuplicateKey() {
            const solution = `
üö® SOLUTION √† l'erreur "duplicate key" :

OPTION 1 (Recommand√©e) - Recr√©er la table :
1. Dans Supabase > Table Editor
2. Supprimez la table "messages"
3. Ex√©cutez ce SQL dans SQL Editor :

CREATE TABLE messages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  username TEXT NOT NULL,
  message TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

OPTION 2 - R√©initialiser la s√©quence :
Ex√©cutez ce SQL :

ALTER SEQUENCE messages_id_seq RESTART WITH 1;
SELECT setval('messages_id_seq', COALESCE((SELECT MAX(id) FROM messages), 0) + 1);
            `;
            
            alert(solution);
        }
        
        // Afficher instructions RLS
        function showRLSInstructions() {
            alert(`
üîì Instructions pour RLS (Row Level Security) :

1. Dans Supabase > Table Editor
2. Cliquez sur la table "messages"
3. Allez dans l'onglet "Policies"
4. D√âSACTIVEZ "Row Level Security" (RLS)
   OU
5. Cr√©ez une politique "Allow all operations"
            `);
        }
        
        // Afficher instructions cr√©ation table
        function showCreateTableInstructions() {
            alert(`
üìã Cr√©er la table "messages" :

1. Dans Supabase > SQL Editor
2. Ex√©cutez cette commande :

CREATE TABLE messages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  username TEXT NOT NULL,
  message TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

3. D√©sactivez RLS dans Table Editor > Policies
            `);
        }
        
        // Effacer l'historique
        async function clearChat() {
            if (!confirm("Effacer TOUS les messages pour tout le monde ?")) return;
            
            if (isTestMode) {
                document.getElementById('messages').innerHTML = 
                    '<div class="message system">' +
                    '<strong>üí≠ Syst√®me</strong><br>Historique effac√© (mode test)' +
                    '</div>';
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('messages')
                    .delete()
                    .neq('id', 0);
                
                if (error) throw error;
                
                document.getElementById('messages').innerHTML = 
                    '<div class="message system">' +
                    '<strong>üí≠ Syst√®me</strong><br>Historique effac√©' +
                    '</div>';
                
            } catch (error) {
                alert("Erreur : " + error.message);
            }
        }
        
        // Changer de pseudo
        function changeUser() {
            const newUsername = prompt("Nouveau pseudo :", currentUser);
            if (newUsername && newUsername.trim()) {
                currentUser = newUsername.trim();
                document.getElementById('currentUser').textContent = currentUser;
            }
        }
        
        // Afficher aide g√©n√©rale
        function showHelp() {
            alert(`
üÜò AIDE - Chat en Temps R√©el

PROBL√àMES COURANTS :

1. "duplicate key" ‚Üí Recr√©ez la table avec AUTO-INCREMENT
2. "row-level security" ‚Üí D√©sactivez RLS
3. "relation does not exist" ‚Üí Cr√©ez la table "messages"

SOLUTIONS :
- Cliquez sur "‚ö° Configuration Auto"
- Ou suivez les instructions d√©taill√©es

RACCOURCIS :
- Ctrl+H : Aide
- Ctrl+F : Fix "duplicate key"
- Ctrl+L : Copier le lien

üìû Besoin d'aide ? Revenez ici !
            `);
        }
        
        // Mettre √† jour le statut
        function updateStatus(text, type) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = `status ${type}`;
        }
        
        // Faire d√©filer vers le bas
        function scrollToBottom() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }
        
        // √âchapper le HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Jouer une notification
        function playNotification() {
            try {
                const audio = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ");
                audio.volume = 0.3;
                audio.play();
            } catch (e) {}
        }
        
        // D√©marrer quand la page est charg√©e
        window.onload = init;
    </script>
</body>
</html>
